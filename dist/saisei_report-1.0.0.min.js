"use strict";var reportApp=angular.module("reportApp",["ngRoute","base64","chart.js","angular-momentjs","angular-loading-bar","angularjs-datetime-picker","angularjs-dropdown-multiselect"]).config(function($routeProvider,$locationProvider,$momentProvider){$momentProvider.asyncLoading(!1).scriptUrl("./lib/moment.min.js"),$routeProvider.when("/report",{templateUrl:"templates/report.html",controller:"ReportCtrl"}).otherwise({redirectTo:"/"}),$locationProvider.html5Mode(!0)}).config(["cfpLoadingBarProvider",function(cfpLoadingBarProvider){cfpLoadingBarProvider.latencyThreshold=1200,cfpLoadingBarProvider.parentSelector="#loading-bar-container",cfpLoadingBarProvider.spinnerTemplate='<div id="loading-bar-spinner"><div class="spinner-icon"></div></div>'}]).run(function($rootScope){$rootScope.users_app_top1=[]});reportApp.controller("MainCtrl",function($scope,$log,$route,$templateCache,$location,$window,SharedData){var from,until;new $window.Sugar.Date(new Date);$scope.select2model=[],$scope.select2data=[{id:1,label:"인터페이스 트래픽"},{id:2,label:"사용자 트래픽"},{id:3,label:"사용자-어플리케이션 트래픽"}],$scope.select2settings={},$scope.currentState=!0,$scope.currentDurationState=SharedData.currentDurationState,$scope.$watch("date_from",function(val){from=val}),$scope.$watch("date_until",function(val){until=val}),$scope.sendDate=function(){var duration=$window.Sugar.Date.range(from,until).every("days").length,_until=new $window.Sugar.Date(until),_from=new $window.Sugar.Date(from);void 0===from||void 0===until?notie.alert({type:"error",text:"리포트 기간을 넣어주세요!!!"}):duration>31?notie.alert({type:"error",text:"리포트 기간은 최대 한달까지 가능합니다!!"}):_until.isFuture().raw?notie.alert({type:"error",text:"리포트 종료 시점은 현재보다 미래로 설정할 수 없습니다!!"}):_from.isFuture().raw?notie.alert({type:"error",text:"리포트 시작 시점은 현재보다 미래로 설정할 수 없습니다!!"}):($scope.currentState=!1,$scope.currentDurationState=!1,SharedData.setFrom(from),SharedData.setUntil(until),$location.path("/report"))}}),reportApp.controller("ReportCtrl",function($rootScope,$scope,$log,ReportData,SharedData,UserAppData,$location,$route,$window,cfpLoadingBar){$scope.$on("$routeChangeStart",function(scope,next,current){SharedData.setCurrentState(!0),$location.path("/"),$window.location.href="/"}),$scope.complete_count=0,$scope.complete_check_count=13,$rootScope.$on("cfpLoadingBar:loaded",function(){$scope.complete_count+=1}),$rootScope.$on("cfpLoadingBar:completed",function(){$scope.complete_count===$scope.complete_check_count&&notie.alert({type:"info",stay:"true",time:30,text:"SAISEI 트래픽 보고서가 완성 되었습니다!!!"})});var from=SharedData.getFrom(),until=SharedData.getUntil(),size={};size.first_page={},size.second_page={},size.third_page={};var _from=new Date(from),_until=new Date(until);$scope.from=_from.toLocaleString(),$scope.until=_until.toLocaleString(),$scope.label=[],$scope.data_rcv_rate=[],$scope.int_date=[],$scope.int_cmp_date=[],$scope.int_rcv_avg=[],$scope.rcv_tot=[],$scope.rcv_len=[],$scope.data_trs_rate=[],$scope.int_trs_avg=[],$scope.trs_tot=[],$scope.trs_len=[],$scope.int_data=[],$scope._users_label=[],$scope._users_from=[],$scope._users_until=[],$scope._users_series=["총사용량(단위:Mbit/s)","다운로드 사용량(단위:Mbit/s)","업로드 사용량(단위:Mbit/s)"],$scope._users_total=[],$scope._users_download=[],$scope._users_upload=[],$scope._users_tb_data=[],$scope._users_app=[],$scope._users_app_top1=[],$scope._users_app_top2=[],$scope._users_app_top3=[],$scope._users_app_data=[],$scope._users_appName_top1=[],$scope._users_appName_top2=[],$scope._users_appName_top3=[],$scope._users_app_label=[],$scope._users_app_series=[],$scope._users_app_option=[];var duration=$window.Sugar.Date.range(from,until).every("days").length;$scope.back=function(){$window.location.reload()},$scope.export_xls=function(){var data1=alasql('SELECT * FROM HTML("#table1",{headers:true})'),data2=alasql('SELECT * FROM HTML("#table2",{headers:true})'),data3=alasql('SELECT * FROM HTML("#table3",{headers:true})');alasql('SELECT * INTO CSV("interface.csv",{headers:true, separator:","}) FROM ?',[data1]),alasql('SELECT * INTO CSV("user_traffic.csv",{headers:true, separator:","}) FROM ?',[data2]),alasql('SELECT * INTO CSV("user_app_traffic.csv",{headers:true, separator:","}) FROM ?',[data3]),notie.alert({type:"error",text:"csv파일이 생성되었습니다!"})},$scope.export=function(){html2canvas(document.getElementById("first_page"),{onrendered:function(canvas){$scope.first_page=canvas.toDataURL()}}),html2canvas(document.getElementById("second_page"),{onrendered:function(canvas){$scope.second_page=canvas.toDataURL()}}),html2canvas(document.getElementById("third_page"),{onrendered:function(canvas){if($scope.third_page=canvas.toDataURL(),size.first_page.width=$("#first_page").width(),size.first_page.height=$("#first_page").height(),size.second_page.width=$("#second_page").width(),size.second_page.height=$("#second_page").height(),size.third_page.width=$("#third_page").width(),size.third_page.height=$("#third_page").height(),duration>=20)ratio=3;else if(10<duration&&duration<20)ratio=2.6;else var ratio=2.2;$scope.docConfig={content:[{image:$scope.first_page,width:Math.ceil(size.first_page.width/ratio),height:Math.ceil(size.first_page.height/size.first_page.width*Math.ceil(size.first_page.width/ratio)),margin:[0,0,0,0],pageBreak:"after"},{image:$scope.second_page,width:Math.ceil(size.second_page.width/ratio),height:Math.ceil(size.second_page.height/size.second_page.width*Math.ceil(size.second_page.width/ratio)),margin:[0,15,0,0],pageBreak:"after"},{image:$scope.third_page,width:Math.ceil(size.third_page.width/ratio),height:Math.ceil(size.third_page.height/size.third_page.width*Math.ceil(size.third_page.width/ratio)),margin:[0,15,0,0]}]},pdfMake.createPdf($scope.docConfig).download("test.pdf",function(){notie.alert({type:"error",text:"pdf 다운로드가 완료 되었습니다!!"})})}})},ReportData.getIntRcvData(function(data){$scope._history_length_rcv_rate=data.data.collection[0]._history_length_receive_rate,$scope._history_rcv=data.data.collection[0]._history_receive_rate,$scope.int_name=data.data.collection[0].name;var from_date=new $window.Sugar.Date(from),_from_date=new $window.Sugar.Date(from);$scope.int_date.push(from_date.format("%F")),$scope.int_cmp_date.push(_from_date.format("%m-%d"));for(j=0;j<duration-1;j++)$scope.int_date.push(from_date.addDays(1).format("%F").raw),$scope.int_cmp_date.push(_from_date.addDays(1).format("%m-%d"));for(i=0;i<$scope._history_length_rcv_rate;i++)i%100==0&&($scope.t=new Date($scope._history_rcv[i][0]),$scope.label.push($scope.t.toLocaleString()),$scope.data_rcv_rate.push(Math.round(.001*$scope._history_rcv[i][1])));for(j=0;j<duration;j++)$scope.rcv_tot.push(0),$scope.rcv_len.push(0);for(j=0;j<duration;j++)for(var i=0;i<$scope._history_length_rcv_rate;i++)$scope.int_cmp_date[j].raw===moment($scope._history_rcv[i][0]).format("MM-DD")&&($scope.rcv_tot[j]+=$scope._history_rcv[i][1],$scope.rcv_len[j]+=1);for(var j=0;j<duration;j++)$scope.int_rcv_avg.push($scope.rcv_tot[j]/$scope.rcv_len[j]);ReportData.getIntTrsData(function(data){$scope._history_length_trs_rate=data.data.collection[0]._history_length_transmit_rate,$scope._history_trs=data.data.collection[0]._history_transmit_rate;for(i=0;i<$scope._history_length_trs_rate;i++)i%100==0&&$scope.data_trs_rate.push(Math.round(.001*$scope._history_trs[i][1]));for(j=0;j<duration;j++)$scope.trs_tot.push(0),$scope.trs_len.push(0);for(j=0;j<duration;j++)for(var i=0;i<$scope._history_length_trs_rate;i++)$scope.int_cmp_date[j].raw===moment($scope._history_trs[i][0]).format("MM-DD")&&($scope.trs_tot[j]+=$scope._history_trs[i][1],$scope.trs_len[j]+=1);for(var j=0;j<duration;j++)$scope.int_trs_avg.push($scope.trs_tot[j]/$scope.trs_len[j]);for(var k=0;k<$scope.int_date.length;k++)$scope.int_data.push({date:$scope.int_date[k],rcv_avg:Math.round(.001*$scope.int_rcv_avg[k]),trs_avg:Math.round(.001*$scope.int_trs_avg[k])});$scope.data=[$scope.data_rcv_rate,$scope.data_trs_rate],$scope.int_rcv_max=Math.max.apply(null,$scope.data_rcv_rate),$scope.int_trs_max=Math.max.apply(null,$scope.data_trs_rate),$scope.int_max=Math.max.apply(null,[$scope.int_rcv_max,$scope.int_trs_max]),$scope.options={scales:{yAxes:[{id:"y-axis-1",type:"linear",display:!0,position:"left",scaleLabel:{display:!0,fontSize:14,labelString:"수신(Mbit/s)",fontStyle:"bold"},ticks:{max:1e3*Math.ceil(.001*$scope.int_max),min:0,beginAtZero:!0,fontSize:12,fontStyle:"bold"}},{id:"y-axis-2",type:"linear",display:!0,position:"right",scaleLabel:{display:!0,fontSize:14,labelString:"송신(Mbit/s)",fontStyle:"bold"},ticks:{max:1e3*Math.ceil(.001*$scope.int_max),min:0,beginAtZero:!0,fontSize:12,fontStyle:"bold"}}],xAxes:[{ticks:{fontSize:12,fontStyle:"bold"},scaleLabel:{display:!0,fontSize:14,labelString:"시간",fontStyle:"bold"}}]}},ReportData.getUserData(function(data){for(var _users=data.data.collection,i=0;i<_users.length;i++){$scope._users_label.push(_users[i].name);var user_from=new Date(_users[i].from);user_from.setHours(user_from.getHours()+9),$scope._users_from.push(user_from.toLocaleString());var user_until=new Date(_users[i].until);$scope._users_until.push(user_until.setHours(user_until.getHours()+9)),$scope._users_total.push(Math.round(.001*_users[i].total_rate)),$scope._users_download.push(Math.round(.001*_users[i].dest_smoothed_rate)),$scope._users_upload.push(Math.round(.001*_users[i].source_smoothed_rate)),$scope._users_tb_data.push({name:_users[i].name,from:user_from.toLocaleString(),until:user_until.toLocaleString(),total:Math.round(.001*_users[i].total_rate),down:Math.round(.001*_users[i].dest_smoothed_rate),up:Math.round(.001*_users[i].source_smoothed_rate)})}$scope._users_data=[$scope._users_total,$scope._users_download,$scope._users_upload],$scope._users_option={scales:{yAxes:[{ticks:{fontSize:12,fontStyle:"bold"},scaleLabel:{display:!0,fontSize:14,labelString:"내부사용자",fontStyle:"bold"}}],xAxes:[{ticks:{fontSize:12,fontStyle:"bold"},scaleLabel:{display:!0,fontSize:14,labelString:"사용량(Mbit/s)",fontStyle:"bold"}}]}};for(i=0;i<$scope._users_label.length;i++)UserAppData.getUserAppData($scope._users_label[i]).then(function(data){var top1_from=new Date(data.data.collection[0].from);top1_from.setHours(top1_from.getHours()+9);var top1_until=new Date(data.data.collection[0].until);top1_until.setHours(top1_until.getHours()+9);var top2_from=new Date(data.data.collection[1].from);top2_from.setHours(top2_from.getHours()+9);var top2_until=new Date(data.data.collection[1].until);top2_until.setHours(top2_until.getHours()+9);var top3_from=new Date(data.data.collection[2].from);top3_from.setHours(top3_from.getHours()+9);var top3_until=new Date(data.data.collection[2].until);top3_until.setHours(top3_until.getHours()+9),$scope._users_app.push({user_name:data.data.collection[0].link.href.split("/")[6],top1_app_name:data.data.collection[0].name,top1_app_total:Math.round(.001*data.data.collection[0].total_rate),top1_app_from:top1_from.toLocaleString(),top1_app_until:top1_until.toLocaleString(),top2_app_name:data.data.collection[1].name,top2_app_total:Math.round(.001*data.data.collection[1].total_rate),top2_app_from:top2_from.toLocaleString(),top2_app_until:top2_until.toLocaleString(),top3_app_name:data.data.collection[2].name,top3_app_total:Math.round(.001*data.data.collection[2].total_rate),top3_app_from:top3_from.toLocaleString(),top3_app_until:top3_until.toLocaleString()}),$scope._users_app.sort(function(a,b){return b.top1_app_total-a.top1_app_total}),$scope._users_app_top1.push(Math.round(.001*data.data.collection[0].total_rate)),$scope._users_app_top2.push(Math.round(.001*data.data.collection[1].total_rate)),$scope._users_app_top3.push(Math.round(.001*data.data.collection[2].total_rate)),$scope._users_appName_top1.push(data.data.collection[0].name),$scope._users_appName_top2.push(data.data.collection[1].name),$scope._users_appName_top3.push(data.data.collection[2].name),$scope._users_app_label.push(data.data.collection[0].link.href.split("/")[6]+"(1."+data.data.collection[0].name+",2."+data.data.collection[1].name+",3."+data.data.collection[2].name+")")});$scope._users_app_data=[$scope._users_app_top1,$scope._users_app_top2,$scope._users_app_top3],$scope._users_app_series=["TOP APP 1","TOP APP 2","TOP APP 3"],$scope._users_app_option={scales:{xAxes:[{ticks:{fontSize:12,fontStyle:"bold"},scaleLabel:{display:!0,fontSize:14,labelString:"APP 사용량(Mbit/s)",fontStyle:"bold"}}],yAxes:[{ticks:{fontSize:12,fontStyle:"bold"},scaleLabel:{display:!0,fontSize:14,labelString:"사용자 어플리케이션(Top1,Top2,Top3)",fontStyle:"bold"}}]}}})}),$scope.labels=$scope.label,$scope.series=["수신(단위:Mbit/s)","송신(단위:Mbit/s)"],$scope.colors=["#ff6384","#45b7cd","#ffe200"],$scope.datasetOverride=[{yAxisID:"y-axis-1"},{yAxisID:"y-axis-2"}]})}),reportApp.service("ReportAuth",function($base64){return function(start){var self=this;this.addId=function(id){return start+=id,self},this.addPasswd=function(pass){return start=start+":"+pass,self},this.getAuth=function(){return{Authorization:"Basic "+$base64.encode(start)}}}}),reportApp.service("ReportConfig",function(){return function(){var result;this.getConfig=function(){return $.getJSON("./config/report-config.json",function(d){result=d.config}),result}}}),reportApp.factory("ReportData",function($http,$log,$base64,$window,ReportFrom,ReportUntil,ReportUrl,ReportQstring,ReportAuth,SharedData){var from=SharedData.getFrom(),until=SharedData.getUntil();$.ajaxSetup({async:!1});var result,config=($.getJSON("./config/report-config.json",function(d){result=d.config}),result);$.ajaxSetup({async:!0});var rest_from=new ReportFrom("").setFrom(from).getFrom(),rest_until=new ReportUntil("").setUntil(until).getUntil(),headers=new ReportAuth("").addId(config.common.id).addPasswd(config.common.passwd).getAuth();return{getUserData:function(successcb){var rest_qstring=new ReportQstring("").addSelect("?select="+config.users_tr.attr).addOrder("&order="+config.users_tr.order).addLimit("&limit="+config.users_tr.limit).addWith("&with="+config.users_tr.with).addFrom("&from="+rest_from).addUntil("&until="+rest_until).getQstring(),rest_url=new ReportUrl("").addDefault(config.common.ip,config.common.port,config.common.path).addSection(config.users_tr.section).addQstring(rest_qstring).getUrls();$http({method:"GET",url:rest_url,headers:headers}).then(function(data,status,headers,config){successcb(data)},function(response){response.status<0&&notie.alert({type:"error",stay:"true",time:3600,text:"ERROR - 유저 데이터가 존재하지 않습니다."})})},getIntRcvData:function(successcb){var rest_qstring=new ReportQstring("").addSelect("?select="+config.interface_rcv.attr).addFrom("&from="+rest_from).addOrder("&operation="+config.interface_rcv.operation).addLimit("&history_points="+config.interface_rcv.hist_point).addUntil("&until="+rest_until).getQstring(),rest_url=new ReportUrl("").addDefault(config.common.ip,config.common.port,config.common.path).addSection(config.interface_rcv.section).addQstring(rest_qstring).getUrls();$http({method:"GET",url:rest_url,headers:headers}).then(function(data,status,headers,config){successcb(data)},function(response){response.status<0&&notie.alert({type:"error",stay:"true",time:3600,text:"ERROR - 인터페이스 데이터가 존재하지 않습니다."})})},getIntTrsData:function(successcb){var rest_qstring=new ReportQstring("").addSelect("?select="+config.interface_trs.attr).addFrom("&from="+rest_from).addOrder("&operation="+config.interface_trs.operation).addLimit("&history_points="+config.interface_trs.hist_point).addUntil("&until="+rest_until).getQstring(),rest_url=new ReportUrl("").addDefault(config.common.ip,config.common.port,config.common.path).addSection(config.interface_trs.section).addQstring(rest_qstring).getUrls();$http({method:"GET",url:rest_url,headers:headers}).then(function(data,status,headers,config){successcb(data),$log.info(data.data.collection[0]._history_length_receive_rate),$log.info(data.data.collection[0]._history_receive_rate)},function(response){response.status<0&&notie.alert({type:"error",stay:"true",time:3600,text:"ERROR - 인터페이스 데이터가 존재하지 않습니다."})})}}}),reportApp.service("ReportFrom",function(){return function(start){var self=this;this.setFrom=function(_from){var from=new Date(_from),_from_yy=moment(from.toUTCString()).utc().format("YYYY"),_from_mm=moment(from.toUTCString()).utc().format("MM"),_from_dd=moment(from.toUTCString()).utc().format("DD"),_from_hh=moment(from.toUTCString()).utc().format("HH"),_from_min=moment(from.toUTCString()).utc().format("mm"),_from_sec=moment(from.toUTCString()).utc().format("ss");return start=start+_from_hh+":"+_from_min+":"+_from_sec+"_"+_from_yy+_from_mm+_from_dd,self},this.getFrom=function(){return start}}}),reportApp.service("ReportQstring",function(){return function(start){var self=this;this.addSelect=function(attr){return start+=attr,self},this.addOrder=function(order){return start+=order,self},this.addLimit=function(limit){return start+=limit,self},this.addWith=function(_with){return start+=_with,self},this.addFrom=function(from){return start+=from,self},this.addUntil=function(until){return start+=until,self},this.getQstring=function(){return start}}}),reportApp.service("ReportUntil",function(){return function(start){var self=this;this.setUntil=function(_until){var until=new Date(_until),_until_yy=moment(until.toUTCString()).utc().format("YYYY"),_until_mm=moment(until.toUTCString()).utc().format("MM"),_until_dd=moment(until.toUTCString()).utc().format("DD"),_until_hh=moment(until.toUTCString()).utc().format("HH"),_until_min=moment(until.toUTCString()).utc().format("mm"),_until_sec=moment(until.toUTCString()).utc().format("ss");return start=start+_until_hh+":"+_until_min+":"+_until_sec+"_"+_until_yy+_until_mm+_until_dd,self},this.getUntil=function(){return start}}}),reportApp.service("ReportUrl",function(){return function(start){var self=this;this.addDefault=function(ip,port,path){return start=start+ip+port+path,self},this.addSection=function(section){return start+=section,self},this.addQstring=function(qstring){return start+=qstring,self},this.getUrls=function(){return start}}}),reportApp.service("SharedData",function(){var sharedData={};return sharedData.currentDurationState=!0,sharedData.currentBtnState=!1,sharedData.currentState=!0,sharedData.from,sharedData.until,{setCurrentState:function(arg){sharedData.currentState=arg},getCurrentState:function(){return sharedData.currentState},getSharedData:function(){return sharedData},setFrom:function(from){sharedData.from=from},setUntil:function(until){sharedData.until=until},getFrom:function(){return sharedData.from},getUntil:function(){return sharedData.until}}}),reportApp.factory("UserAppData",function($http,$log,$base64,$window,ReportConfig,ReportFrom,ReportUntil,ReportUrl,ReportQstring,ReportAuth,SharedData){var from=SharedData.getFrom(),until=SharedData.getUntil();$.ajaxSetup({async:!1});var result,config=($.getJSON("./config/report-config.json",function(d){result=d.config}),result);return $.ajaxSetup({async:!0}),{getUserAppData:function(userid){var rest_from=new ReportFrom("").setFrom(from).getFrom(),rest_until=new ReportUntil("").setUntil(until).getUntil(),rest_qstring=new ReportQstring("").addSelect("?select="+config.user_app.attr).addOrder("&order="+config.user_app.order).addLimit("&limit="+config.user_app.limit).addWith("&with="+config.user_app.with).addFrom("&from="+rest_from).addUntil("&until="+rest_until).getQstring(),rest_url=new ReportUrl("").addDefault(config.common.ip,config.common.port,config.common.path).addSection(config.user_app.section.replace(":userID",userid)).addQstring(rest_qstring).getUrls(),headers=new ReportAuth("").addId(config.common.id).addPasswd(config.common.passwd).getAuth();return $http({method:"GET",url:rest_url,headers:headers}).then(function(data,status,headers,config){return data},function(response){response.status<0&&notie.alert({type:"error",stay:"true",time:3600,text:"ERROR - 유저 데이터가 존재하지 않습니다."})})}}});